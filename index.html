<!-- https://bl.ocks.org/altocumulus/0fefcd64ca84319643b56ee9e722407f -->
<!DOCTYPE html>
<meta charset="utf-8" />
<title>Planet House</title>
<style>
  .stroke {
    fill: none;
    stroke: #000;
    stroke-width: 3px;
  }

  .fill {
    fill: #fff;
  }

  .graticule {
    fill: none;
    stroke: #777;
    stroke-width: 0.5px;
    stroke-opacity: 0.5;
  }

  .land {
    fill: #222;
    stroke: red;
    fill: white;
  }

  .boundary {
    fill: none;
    stroke: salmon;
    stroke-width: 0.5px;
  }

  .circle {
    stroke: black;
    fill-opacity: 0;
  }
  .invisible * {
    stroke: transparent;
    fill: transparent;
  }
</style>

<div id="content"></div>

<div id="controls">
  <label for="lon">Longitude (°): <input id="lon" type="number" min="-180" max="180" value="0" /></label>
  <label for="lat">Latitude (°): <input id="lat" type="number" min="-90" max="90" value="0" /></label>
  <label for="rot">Rotate (°): <input id="rot" type="number" min="0" max="360" value="0" /></label>
</div>

<svg width="960" height="960"></svg>

<p>
  <a href="https://github.com/fasiha/planet-house">Source code</a>
</p>

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://unpkg.com/topojson-client@2"></script>
<script src="index.js"></script>
<script type="module">
  import { reactive, html, watch } from "https://esm.sh/@arrow-js/core";
  // Start your app here!

  var EARTH_RADIUS_KM = 6371;
  var computed = compute(11.7);
  var solarSystem = Object.values(computed);

  const worldPromise = d3.json("https://unpkg.com/world-atlas@1/world/50m.json");

  async function draw(lon, lat, rot = 0) {
    var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

    d3.select("svg").selectAll("*").remove();

    svg.append("use").attr("class", "stroke").attr("xlink:href", "#sphere");
    svg.append("use").attr("class", "fill").attr("xlink:href", "#sphere");

    var projection = d3
      .geoAzimuthalEquidistant()
      .scale((width - 3) / (2 * Math.PI))
      .translate([width / 2, height / 2])
      .rotate([-lon, -lat, rot]);

    var path = d3.geoPath().projection(projection);

    svg.append("defs").append("path").datum({ type: "Sphere" }).attr("id", "sphere").attr("d", path);

    var circle = d3
      .geoCircle()
      .center([lon, lat])
      .radius((radiusMeter) => (((radiusMeter * 1e-3) / EARTH_RADIUS_KM) * 180) / Math.PI);

    const world = await worldPromise;
    svg
      .insert("path", ".graticule")
      .datum(topojson.feature(world, world.objects.land))
      .attr("class", "land")
      .attr("d", path);

    svg
      .insert("path", ".graticule")
      .datum(
        topojson.mesh(world, world.objects.countries, function (a, b) {
          return a !== b;
        })
      )
      .attr("class", "boundary")
      .attr("d", path);
    svg
      .selectAll(".circle")
      .data(solarSystem.map((o) => o.orbitBase))
      .enter()
      .append("g")
      .attr("class", "circle-group")
      .attr("id", (d, i) => "group-" + solarSystem[i].title.split(" ")[0])
      .each(function (d, i) {
        const circlePath = d3.select(this).append("path").attr("class", "circle");
        const labelText = d3.select(this).append("text").attr("class", "label");

        circlePath
          .datum(circle)
          .attr("d", path)
          .attr("id", "circle-" + solarSystem[i].title.split(" ")[0]);

        const [cx, cy] = path.centroid(circlePath.datum());
        if (!(isFinite(cx) && isFinite(cy))) {
          return;
        }
        const { width } = circlePath.node().getBBox();
        const radius = width / 2;

        const textX = cx;
        const textY = cy + radius;

        labelText
          .attr("x", textX)
          .attr("y", textY)
          .attr("text-anchor", "middle")
          .attr("dy", 15)
          .text(solarSystem[i].title);
      });
  }

  var [lon, lat, rot] = [-75, 40.5, 0];
  draw(lon, lat, rot).then(() => showSelected());

  const [lonElement, latElement, rotElement] = ["#lon", "#lat", "#rot"].map((q) => document.querySelector(q));

  lonElement.value = lon;
  latElement.value = lat;
  rotElement.value = rot;

  lonElement.addEventListener("change", (e) => {
    lon = +e.target.value;
    draw(lon, lat, rot);
  });
  latElement.addEventListener("change", (e) => {
    lat = +e.target.value;
    draw(lon, lat, rot);
  });
  rotElement.addEventListener("change", (e) => {
    rot = +e.target.value;
    draw(lon, lat, rot);
  });

  // arrow.js: Table

  const tableSort = reactive({
    diameter: true,
    ascending: false,
  });
  const solarSystemReactive = reactive({
    data: solarSystem.map((o) => ({ ...o, selected: !o.title.includes(" ") })),
  });

  function resort() {
    if (tableSort.diameter) {
      solarSystemReactive.data.sort((a, b) => (a.diameterBase - b.diameterBase) * (tableSort.ascending ? 1 : -1));
    } else {
      solarSystemReactive.data.sort((a, b) => (a.orbitBase - b.orbitBase) * (tableSort.ascending ? 1 : -1));
    }
  }

  function showSelected() {
    for (const row of solarSystemReactive.data) {
      const id = "#group-" + row.title.split(" ")[0];
      const node = document.querySelector(id);
      if (!node) continue;
      const classes = node.classList;
      if (row.selected) classes.remove("invisible");
      else classes.add("invisible");
    }
  }
  watch(showSelected);

  const buttonDiameter = html`<button
    @click="${() => {
      if (tableSort.diameter === true) tableSort.ascending = !tableSort.ascending;
      else tableSort.ascending = false;

      tableSort.diameter = true;
      resort();
    }}"
  >
    ${() => (tableSort.diameter ? (tableSort.ascending ? "v" : "^") : "?")}
  </button>`;
  const buttonOrbit = html`<button
    @click="${() => {
      if (tableSort.diameter === false) tableSort.ascending = !tableSort.ascending;
      else tableSort.ascending = false;

      tableSort.diameter = false;
      resort();
    }}"
  >
    ${() => (!tableSort.diameter ? (tableSort.ascending ? "v" : "^") : "?")}
  </button>`;

  const table = html`<table>
    <thead>
      <tr>
        <td>Object</td>
        <td>Diameter ${() => buttonDiameter}</td>
        <td>Orbit distance ${() => buttonOrbit}</td>
      </tr>
    </thead>
    <tbody>
      ${() =>
        solarSystemReactive.data.map(
          (row) =>
            html`<tr>
              <td>
                <label for="${() => "check-" + row.title.split(" ")[0]}">
                  <input
                    id="${() => "check-" + row.title.split(" ")[0]}"
                    type="checkbox"
                    checked="${() => row.selected}"
                    @change="${() => (row.selected = !row.selected)}"
                  />
                  ${row.title}</label
                >
              </td>
              <td>${noMegaMeters(row.diameterBase)}</td>
              <td>${noMegaMeters(row.orbitBase)}</td>
            </tr>`
        )}
    </tbody>
  </table>`;
  table(document.querySelector("#content"));
</script>
